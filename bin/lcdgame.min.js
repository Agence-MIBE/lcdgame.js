/*! LCD game JavaScript library -- by BdR 2018 */
var LCDGAME_VERSION="0.3.4";var LCDGame=LCDGame||{loadsounds:null,countimages:0,scaleFactor:1,score:0,gametype:0,level:0,buttonpress:0,playtimestart:null,onImageLoaded:null,onImageError:null,canvas:null,context2d:null,debugtxt:null};LCDGame.State=function(){this.lcdgame=null;this.key="";this.statemanager=null};LCDGame.State.prototype={init:function(){},preload:function(){},loadUpdate:function(){},loadRender:function(){},create:function(){},update:function(){}};LCDGame.State.prototype.constructor=LCDGame.State;LCDGame.StateManager=function(t){this.lcdgame=t;this._currentState="";this._pendingState="";this.states={}};LCDGame.StateManager.prototype={add:function(t,e){this.states[t]=new e(this.lcdgame);this._pendingState=t;return e},start:function(t){this.lcdgame.cleartimers();if(this._currentState){this.states[this._currentState].destroy;this._currentState=""}this._pendingState=t},currentState:function(){if(this._currentState){return this.states[this._currentState]}},checkSwitch:function(){if(this._currentState!=this._pendingState){this._currentState=this._pendingState;this.states[this._currentState].init()}}};LCDGame.AnimationFrame=function(t){this.lcdgame=t;this.raftime=null};LCDGame.AnimationFrame.prototype={start:function(){var t=["ms","moz","webkit","o"];for(var e=0;e<t.length&&!window.requestAnimationFrame;e++){window.requestAnimationFrame=window[t[e]+"RequestAnimationFrame"];window.cancelAnimationFrame=window[t[e]+"CancelAnimationFrame"]}animationlast=0;var a=this;if(!window.requestAnimationFrame){useSetTimeout=true;animationLoop=function(){return a.updateSetTimeout()};_timeOutID=window.setTimeout(this.animationLoop,0)}else{useSetTimeout=false;animationLoop=function(t){return a.updateAnimFrame(t)};_timeOutID=window.requestAnimationFrame(animationLoop)}},updateAnimFrame:function(t){this.lcdgame.state.checkSwitch();this.raftime=Math.floor(t);this.lcdgame.updateloop(this.raftime);_timeOutID=window.requestAnimationFrame(animationLoop)},updateSetTimeout:function(){this.lcdgame.state.checkSwitch();this.raftime=Date.now();this.lcdgame.updateloop(this.raftime);var t=Math.floor(1e3/60);_timeOutID=window.setTimeout(animationLoop,t)}};var MENU_HTML='<div class="container">'+'  <canvas id="mycanvas" class="gamecvs"></canvas>'+'  <a class="mybutton btnmenu" onclick="displayInfobox();">help</a>'+'  <a class="mybutton btnmenu" onclick="displayScorebox();">highscores</a>'+'  <div class="infobox" id="infobox">'+'    <div id="infocontent">'+"      instructions"+"    </div>"+'    <a class="mybutton btnpop" onclick="hideInfobox();">Ok</a>'+"  </div>"+"</div>";function displayInfobox(){hideScorebox();document.getElementById("infobox").style.display="inherit"}function hideInfobox(){document.getElementById("infobox").style.display="none"}LCDGame.Menu=function(t,e){this.lcdgame=t};var SCORE_HTML='<div class="infobox" id="scorebox">'+'  <div id="scoreheader">'+"  </div>"+'  <div id="scorecontent">'+"    One moment..."+"  </div>"+'  <a class="mybutton btnnext" id="btnprev" data-direction="-1">&lt;&lt;</a>'+'  <a class="mybutton btnnext" id="btnnext" data-direction="+1">&gt;&gt;</a>'+'  <a class="mybutton btnpop" onclick="hideScorebox();">Ok</a>'+"</div>";var HS_URL="http://bdrgames.nl/lcdgames/testphp/";function displayScorebox(){hideInfobox();document.getElementById("scorebox").style.display="inherit"}function hideScorebox(){document.getElementById("scorebox").style.display="none"}var RANKS_PER_PAGE=10;LCDGame.HighScores=function(t,e,a){this.lcdgame=t;this.gametitle=e;this.gametypes=a;this.offset=0;this._scores_local=[];this._scores_global=[];this._scoretype=0};LCDGame.HighScores.prototype={init:function(t){var e=document.getElementById("btnprev");var a=document.getElementById("btnnext");e.addEventListener("click",this.onPrevNextButton.bind(this));a.addEventListener("click",this.onPrevNextButton.bind(this));this.buildHeaderHTML();this.loadLocal(t);this.loadGlobal()},getGametype:function(){var t="";if(this.gametypes){t=this.gametypes[this._scoretype-1]}return t},loadLocal:function(t){this._scores_local=[];this._scoretype=t;var e="lcdgame_local_"+this.gametitle+"_hs"+t;var a=window.localStorage.getItem(e);try{this._scores_local=JSON.parse(a)}catch(t){this._scores_local=[]}if(Object.prototype.toString.call(this._scores_local)!=="[object Array]"){this._scores_local=[]}},indexLocal:function(t,e){if(e!=this._scoretype){this.loadLocal(e)}var a=-1;for(var s=this._scores_local.length-1;s>=0;s--){if(t>this._scores_local[s].score){a=s}else{break}}return a},saveLocal:function(t,e,a,s){var i={player:t,score:e,level:a};var n=this.indexLocal(e,s);if(n<0){this._scores_local.push(i)}else{this._scores_local.splice(n,0,i)}var o="lcdgame_local_"+this.gametitle+"_hs"+s;window.localStorage.setItem(o,JSON.stringify(this._scores_local));window.localStorage.setItem("lcdgame_highscore_name",t)},saveGlobal:function(t,e,a,s,i,n){if(platform){var o=(platform.product?"&device="+platform.product:"")+(platform.os?"&os="+platform.os:"")+(platform.name?"&browser="+platform.name:"")}else{var r=this.guessOsBrowser();var o="&device="+r.device+"&os="+r.os+"&browser="+r.browser}var h=navigator.language;var d=this.getClientGUID();this._scoretype=s;var t=t.replace(/\&/g,"%26");var l=HS_URL+"newhs.php";var c="gamename="+this.gametitle+"&gametype="+s+"&player="+t+"&score="+e+"&level="+a+"&playtime="+i+"&buttonpress="+n+o+"&language="+h+"&lcdversion="+LCDGAME_VERSION+"&clientguid="+d;var m=new XMLHttpRequest;m.open("POST",l,true);m.setRequestHeader("Content-Type","application/x-www-form-urlencoded; charset=UTF-8");m.onreadystatechange=function(t){if(m.status>=200&&m.status<400){if(m.readyState==4&&m.status==200){console.log("SUCCESS!!\nrequest.status="+m.status+"\nrequest.response="+m.response);var e=JSON.parse(m.response);if(e.result=="OK"){console.log("Highscore sent succesfully");var a=e.rank?!isNaN(e.rank)?e.rank:1:1;this.offset=RANKS_PER_PAGE*Math.floor((a-1)/RANKS_PER_PAGE);this.loadGlobal();displayScorebox()}else{console.log("Highscore sent failed")}}}else{console.log("Highscore sent failed with error "+m.status+": "+m.statusText)}}.bind(this);m.send(c)},getHighscore:function(t){var e=0;if(this.lcdgame.highscores._scores_global[0]){e=this.lcdgame.highscores._scores_global[0].score}return e},checkScore:function(){var t=new Date;var e=this.lcdgame.score;var a=this.lcdgame.level;var s=this.lcdgame.gametype;var i=Math.floor((t-this.lcdgame.playtimestart)/1e3);var n=this.lcdgame.buttonpress;if(e>0){var o=window.localStorage.getItem("lcdgame_highscore_name")||"";var r=prompt("New highscore, enter your name and press enter to submit or press cancel.",o);if(r!=null){r=r.trim();if(r!=""){this.saveLocal(r,e,a,s);this.saveGlobal(r,e,a,s,i,n)}}}},loadGlobal:function(){var t=HS_URL+"geths.php"+"?gamename="+this.gametitle+"&gametype="+this._scoretype+"&offset="+this.offset;var e=new XMLHttpRequest;e.open("GET",t,true);e.setRequestHeader("Content-Type","application/x-www-form-urlencoded; charset=UTF-8");e.onreadystatechange=function(){if(e.readyState==4&&e.status==200)this.afterLoadGlobal(e.responseText)}.bind(this);e.send(null)},afterLoadGlobal:function(t){try{this._scores_global=JSON.parse(t)}catch(t){this._scores_global=[]}if(Object.prototype.toString.call(this._scores_global)!=="[object Array]"){this._scores_global=[]}for(var e=0;e<this._scores_global.length;e++){this._scores_global[e].local=false;for(var a=0;a<this._scores_local.length;a++){if(this._scores_global[e].player==this._scores_local[a].player&&this._scores_global[e].score==this._scores_local[a].score){this._scores_global[e].local=true}}}this.refreshHTML()},onFilterButton:function(t){if(t.currentTarget.dataset){var e=parseInt(t.currentTarget.dataset.gametype);if(this.gametype!=e){this.offset=0;this.loadLocal(e);this.loadGlobal()}}},onPrevNextButton:function(t){if(t.currentTarget.dataset){var e=parseInt(t.currentTarget.dataset.direction);var a=this.offset+(e>0?RANKS_PER_PAGE:-1*RANKS_PER_PAGE);if(a<0)a=0;if(e>0&&this._scores_global.length<RANKS_PER_PAGE)a=this.offset;if(this.offset!=a){this.offset=a;this.loadGlobal()}}},buildHeaderHTML:function(){var t='<h1 id="scoretitle">'+this.gametitle+"</h1>";for(var e=this.gametypes.length-1;e>=0;e--){t=t+'<a class="filter" data-gametype="'+(e+1)+'" id="filtertype'+e+'">'+this.gametypes[e]+"</a>"}document.getElementById("scoreheader").innerHTML=t;for(var e=0;e<this.gametypes.length;e++){var a=document.getElementById("filtertype"+e);a.addEventListener("click",this.onFilterButton.bind(this))}},refreshHTML:function(){var t="";for(var e=0;e<RANKS_PER_PAGE;e++){var a=this._scores_global[e];if(typeof a==="undefined"){var s=this.offset+(e+1);a={rank:s,player:".....",score:0,level:1,local:false}}var i=a.local?' style="color:#f00"':"";t=t+"      <tr"+i+"><td>"+a.rank+".</td><td>"+a.player+"</td><td>"+a.score+"</td></tr>"}var n="<table>"+"      <tr><td>Rk.</td><td>Name</td><td>Score</td></tr>"+t+"    </table>";this.lcdgame.scorecontent.innerHTML=n;n=this.gametitle+" ("+this.getGametype()+")";document.getElementById("scoretitle").innerHTML=n},uuidv4:function(){var t="";var e;for(var a=0;a<32;a++){e=Math.random()*16|0;if(a==8||a==12||a==16||a==20){t+="-"}t+=(a==12?4:a==16?e&3|8:e).toString(16)}return t},getClientGUID:function(){var t=window.localStorage.getItem("lcdgame_client_guid");if(!t){t=this.uuidv4();window.localStorage.setItem("lcdgame_client_guid",t)}return t},guessOsBrowser:function(){var t="";var e="";var a="";var s=navigator.userAgent||navigator.vendor||window.opera;if(/BlackBerry|BB10|PlayBook|Passport/i.test(s)){t="BlackBerry"}else if(/GT-I9\d{3}|SM-G9\d{2}/.test(s)){t="Galaxy S-series"}else if(/SM-A\d{3}/.test(s)){t="Galaxy A-series"}else if(/SM-J\d{3}/.test(s)){t="Galaxy J-series"}else if(/SM-T\d{3}/.test(s)){t="Galaxy Tab"}else if(/SM-N\d{3}/.test(s)){t="Galaxy Note"}else if(/SAMSUNG/.test(s)){t="Samsung"}else if(/huawei/i.test(s)){t="Huawei"}else if(/kindle/.test(s)){t="Kindle"}else if(/xbox one/i.test(s)){t="Xbox One"}else if(/xbox/i.test(s)){t="Xbox 360"}else if(/playstation /i.test(s)){t=/playstation [^;) ]*/i.exec(s)||"Playstation"}else if(/nintendo wii/i.test(s)){t="Wii U"}else if(/IEMobile|Windows Phone/i.test(s)){t="Windows Phone"}else if(/iPad|iPhone|iPod/.test(s)&&!window.MSStream){if(/iPad/.test(s)){t="iPad"}else if(/iPod/.test(s)){t="iPod"}else t="iPhone"}else if(/mac os|macintosh/i.test(s)){t="Macintosh"}if(/tizen /i.test(s)){e=/tizen [^;)]*/i.exec(s)[0]||"Tizen"}else if(/windows phone/i.test(s)){e="Windows Phone"}else if(/android /i.test(s)){e=/android [^;)]*/i.exec(s)[0]||"Android"}else if(/iPad|iPhone|iPod/.test(s)&&!window.MSStream){var i=/(iphone os |cpu os )[^;) ]*/i.exec(s);e=i[0]||"";e=e.replace(/cpu|iphone|os/gi,"").trim();e="iOS "+e.replace(/_/g,".")}else if(/mac os/i.test(s)){e="Mac OS"}else if(/windows /i.test(s)){var i=/windows [^;)]*/i.exec(s)[0];e=i||"Windows";if(/10/.test(i))e="Windows 10";if(/6.3/.test(i))e="Windows 8.1";if(/6.2/.test(i))e="Windows 8";if(/6.1/.test(i))e="Windows 7";if(/6.0/.test(i))e="Windows Vista";if(/5.1|5.2/.test(i))e="Windows XP";if(/5.0/.test(i))e="Windows 2000"}else{e=navigator.platform}if(!!window.opr&&!!opr.addons||!!window.opera||navigator.userAgent.indexOf(" OPR/")>=0){a="Opera 8.0+"}else if(typeof InstallTrigger!=="undefined"){a="Firefox 1.0+"}else if(/edge/i.test(s)){a="Edge"}else if(/chrome/i.test(s)&&/google/i.test(navigator.vendor)){a="Chrome"}else if(/safari/i.test(s)&&/apple computer/i.test(navigator.vendor)){a="Safari"}else if(/iemobile/i.test(s)){a=/iemobile[^;) ]*/i.exec(s)[0]||"IEMobile"}else if(/MSIE /.test(s)){a=/MSIE [^;) ]*/.exec(s)[0]||"MSIE"}else if(/rv\:11\./.test(s)){a="MSIE 11"}else if(false||!!document.documentMode){a="MSIE 6-11"}t=t.replace(/&|\?|\//g," ").trim();e=e.replace(/&|\?|\//g," ").trim();a=a.replace(/&|\?|\//g," ").trim();return{device:t,os:e,browser:a}}};LCDGame.Game=function(t,e){this.gamedata=[];this.imageBackground=null;this.imageShapes=null;this.score=0;this.gametype=0;this.level=0;this.buttonpress=0;this.playtimestart=null;this.soundmute=false;this.countimages=0;this.scaleFactor=1;this.imageBackground=new Image;this.imageShapes=new Image;if(this.imageBackground.addEventListener){this.imageBackground.addEventListener("load",this.onImageLoaded.bind(this));this.imageBackground.addEventListener("error",this.onImageError.bind(this));this.imageShapes.addEventListener("load",this.onImageLoaded.bind(this));this.imageShapes.addEventListener("error",this.onImageError.bind(this))}else{this.imageBackground.attachEvent("load",this.onImageLoaded.bind(this));this.imageBackground.attachEvent("error",this.onImageError.bind(this));this.imageShapes.attachEvent("load",this.onImageLoaded.bind(this));this.imageShapes.attachEvent("error",this.onImageError.bind(this))}var a=MENU_HTML+SCORE_HTML;document.write(a);this.canvas=document.getElementById("mycanvas");this.infobox=document.getElementById("infobox");this.scorebox=document.getElementById("scorebox");this.infocontent=document.getElementById("infocontent");this.scorecontent=document.getElementById("scorecontent");this.context2d=this.canvas.getContext("2d");this.state=new LCDGame.StateManager(this);this.raf=new LCDGame.AnimationFrame(this);this.timers=[];this.loadConfig(t);e=e||"metadata/gameinfo.json";this.loadMetadata(e);this._touchdevice=false;return this};LCDGame.Game.prototype={onImageLoaded:function(){this.countimages++;if(this.countimages>=2){this.initGame()}},onImageError:function(){console.log("** ERROR ** lcdgame.js - onImageError.")},loadConfig:function(t){var e=function(){if(a.readyState===XMLHttpRequest.DONE){if(a.status===200||a.status===0){this.onConfigLoad(JSON.parse(a.responseText))}else{this.onConfigError(a)}}};var a=new XMLHttpRequest;a.onreadystatechange=e.bind(this);a.open("GET",t,true);a.send()},onConfigLoad:function(t){this.gamedata=t;this.imageBackground.src=t.imgback;this.imageShapes.src=t.imgshapes;for(var e=0;e<this.gamedata.frames.length;e++){this.gamedata.frames[e].value=false;this.gamedata.frames[e].valprev=false;this.gamedata.frames[e].type="shape"}for(var a=0;a<this.gamedata.sequences.length;a++){this.gamedata.sequences[a].ids=[];for(var s=0;s<this.gamedata.sequences[a].frames.length;s++){var i=this.gamedata.sequences[a].frames[s];var n=this.shapeIndexByName(i);this.gamedata.sequences[a].ids.push(n)}}for(var o=0;o<this.gamedata.digits.length;o++){this.gamedata.digits[o].ids=[];this.gamedata.digits[o].locids=[];for(var s=0;s<this.gamedata.digits[o].frames.length;s++){var i=this.gamedata.digits[o].frames[s];var n=this.shapeIndexByName(i);this.gamedata.digits[o].ids.push(n);if(n!=-1){this.gamedata.frames[n].type="digit"}}for(var r=0;r<this.gamedata.digits[o].locations.length;r++){var i=this.gamedata.digits[o].locations[r];var n=this.shapeIndexByName(i);this.gamedata.digits[o].locids.push(n)}var h=this.gamedata.digits[o].max||"";if(h==""){for(var d=0;d<this.gamedata.digits[o].locids.length;d++){h+="8"}this.gamedata.digits[o].max=h}}for(var l=0;l<this.gamedata.buttons.length;l++){this.gamedata.buttons[l].ids=[];var c=1e4;var m=1e4;var u=0;var f=0;for(var s=0;s<this.gamedata.buttons[l].frames.length;s++){var i=this.gamedata.buttons[l].frames[s];var n=this.shapeIndexByName(i);this.gamedata.buttons[l].ids.push(n);this.gamedata.frames[n].type="button";var g=this.gamedata.frames[n].spriteSourceSize;if(g.x<c)c=g.x;if(g.y<m)m=g.y;if(g.x+g.w>u)u=g.x+g.w;if(g.y+g.h>f)f=g.y+g.h}var v=u-c;var p=f-m;var c=c-v;var m=m-p;var u=u+v;var f=f+p;var b=(c+u)/2;var y=(m+f)/2;this.gamedata.buttons[l].area={x1:c,y1:m,x2:u,y2:f,xc:b,yc:y};var x=this.gamedata.buttons[l].name;if(typeof this.gamedata.buttons[l].defaultkeys!=="undefined"){x=this.gamedata.buttons[l].defaultkeys}this.gamedata.buttons[l].keycodes=this.determineKeyCodes(x)}for(var w=0;w<this.gamedata.buttons.length-1;w++){for(var S=w+1;S<this.gamedata.buttons.length;S++){if(this.gamedata.buttons[w].area.x1<this.gamedata.buttons[S].area.x2&&this.gamedata.buttons[w].area.x2>this.gamedata.buttons[S].area.x1&&this.gamedata.buttons[w].area.y1<this.gamedata.buttons[S].area.y2&&this.gamedata.buttons[w].area.y2>this.gamedata.buttons[S].area.y1){var _=this.gamedata.buttons[w].area.xc;var E=this.gamedata.buttons[w].area.yc;var L=this.gamedata.buttons[S].area.xc;var I=this.gamedata.buttons[S].area.yc;if(Math.abs(_-L)>Math.abs(E-I)){if(_>L){var k=(this.gamedata.buttons[w].area.x1-this.gamedata.buttons[S].area.x2)/2;this.gamedata.buttons[w].area.x1-=k;this.gamedata.buttons[S].area.x2+=k}else{var k=(this.gamedata.buttons[w].area.x2-this.gamedata.buttons[S].area.x1)/2;this.gamedata.buttons[w].area.x2-=k;this.gamedata.buttons[S].area.x1+=k}}else{if(E>I){var k=(this.gamedata.buttons[w].area.y1-this.gamedata.buttons[S].area.y2)/2;this.gamedata.buttons[w].area.y1-=k;this.gamedata.buttons[S].area.y2+=k}else{var k=(this.gamedata.buttons[w].area.y2-this.gamedata.buttons[S].area.y1)/2;this.gamedata.buttons[w].area.y2-=k;this.gamedata.buttons[S].area.y1+=k}}}}}},onConfigError:function(t){console.log("** ERROR ** lcdgame.js - onConfigError: error loading json file");console.error(t)},loadMetadata:function(t){var e=function(){if(a.readyState===XMLHttpRequest.DONE){if(a.status===200||a.status===0){this.onMetadataLoad(JSON.parse(a.responseText))}else{this.onMetadataError(a)}}};var a=new XMLHttpRequest;a.onreadystatechange=e.bind(this);a.open("GET",t,true);a.send()},tinyMarkDown:function(t){t=t.replace(/\n/gi,"<br/>");t=t.replace(/\*.*?\*/g,function(t){return"<b>"+t.slice(1,-1)+"</b>"});t=t.replace(/\_.*?\_/g,function(t){return"<i>"+t.slice(1,-1)+"</i>"});t=t.replace(/\[(?:(?!\[).)*?\](?!\()/g,function(t){return"<btn>"+t.slice(1,-1)+"</btn>"});t=t.replace(/(\[(?:(?!\[).)*?\])(\((?:(?!\().)*?\))/g,function(t,e,a,s){var i=a.slice(1,-1);if(i.indexOf("http")!=0)i="http://"+i;var n=e.slice(1,-1);return'<a href="'+i+'">'+n+"</a>"});return t},onMetadataLoad:function(t){this.metadata=t;var e=this.tinyMarkDown(t.gameinfo.instructions.en);this.infocontent.innerHTML="<h1>How to play</h1><br/>"+e;var a=t.gameinfo.device.title;var s=t.gameinfo.gametypes;this.gametype=typeof s==="undefined"?0:1;this.highscores=new LCDGame.HighScores(this,a,s);this.highscores.init(this.gametype)},onMetadataError:function(t){console.log("** ERROR ** lcdgame.js - onMetadataError: error loading json file");console.error(t)},resizeCanvas:function(){var t=window.innerWidth/window.innerHeight;var e=this.canvas.width/this.canvas.height;var a=this.canvas.width;var s=this.canvas.height;if(e>t){a=window.innerWidth;this.scaleFactor=a/this.canvas.width;s=this.canvas.height*this.scaleFactor;var i=(window.innerHeight-s)/2;this.canvas.style["margin-top"]=i+"px";this.canvas.style["margin-bottom"]=-i+"px";this.canvas.style["margin-left"]="0px"}else{s=window.innerHeight;this.scaleFactor=s/this.canvas.height;a=this.canvas.width*this.scaleFactor;var n=(window.innerWidth-a)/2;this.canvas.style["margin-left"]=n+"px";this.canvas.style["margin-right"]=-n+"px";this.canvas.style["margin-top"]="0px"}this.canvas.style.width=a+"px";this.canvas.style.height=s+"px";this.canvas.style.display="block";this.canvas.style["touch-action"]="none";this.canvas.style["user-select"]="none";this.canvas.style["-webkit-tap-highlight-color"]="rgba(0, 0, 0, 0)";this.resizeInfobox(this.infobox);this.resizeInfobox(this.scorebox)},resizeInfobox:function(t){t.style.display="inherit";var e=t.offsetWidth;var a=t.offsetHeight;var s=t.getBoundingClientRect();if(s){e=s.width;a=s.height}var i=(window.innerWidth-e)/2;var n=(window.innerHeight-a)/2;t.style["margin-left"]=i+"px";t.style["margin-right"]=-i+"px";t.style["margin-top"]=n+"px";t.style["margin-bottom"]=-n+"px";t.style.display="none"},initGame:function(){document.body.scrollTop=0;document.body.style.overflow="hidden";this.canvas.width=this.imageBackground.width;this.canvas.height=this.imageBackground.height;this.context2d.drawImage(this.imageBackground,0,0);for(var t=0;t<this.gamedata.sounds.length;t++){var e=this.gamedata.sounds[t].filename;this.gamedata.sounds[t].audio=new Audio(e);this.gamedata.sounds[t].audio.load()}if("ontouchstart"in document.documentElement||window.navigator.maxTouchPoints&&window.navigator.maxTouchPoints>=1){this._touchdevice=true}if(document.addEventListener){this.canvas.addEventListener("mousedown",this.onmousedown.bind(this),false);this.canvas.addEventListener("mouseup",this.onmouseup.bind(this),false);document.addEventListener("keydown",this.onkeydown.bind(this),false);document.addEventListener("keyup",this.onkeyup.bind(this),false);if(this._touchdevice){this.canvas.addEventListener("touchstart",this.ontouchstart.bind(this),false);this.canvas.addEventListener("touchend",this.ontouchend.bind(this),false)}}else{this.canvas.attachEvent("mousedown",this.onmousedown.bind(this));this.canvas.attachEvent("mouseup",this.onmouseup.bind(this));document.attachEvent("keydown",this.onkeydown.bind(this));document.attachEvent("keyup",this.onkeyup.bind(this))}window.addEventListener("resize",this.resizeCanvas.bind(this),false);this.resizeCanvas();displayInfobox();this.raf.start();console.log("lcdgame.js v"+LCDGAME_VERSION+" :: start")},addtimer:function(t,e,a,s){if(typeof s==="undefined")s=true;var i=new LCDGame.Timer(t,e,a,s);this.timers.push(i);return i},cleartimers:function(){for(var t=0;t<this.timers.length;t++){this.timers[t].pause();this.timers[t]=null}this.timers=[]},updateloop:function(t){for(var e=0;e<this.timers.length;e++){if(this.timers[e].enabled){this.timers[e].update(t)}}if(this._refresh){this.shapesRefresh();this._refresh=false}},gameReset:function(t){this.score=0;this.level=0;this.gametype=t;this.buttonpress=0;this.playtimestart=new Date},loadSoundEffects:function(){console.log("loadSoundEffects - TODO load sound effects")},setSoundMute:function(t){this.soundmute=t},soundIndexByName:function(t){var e=0;for(var a=0;a<this.gamedata.sounds.length;a++){if(this.gamedata.sounds[a].name==t){return a}}return-1},playSoundEffect:function(t){if(!this.soundmute){var e=this.soundIndexByName(t);if(e>=0){if(this.gamedata.sounds[e].audio.paused==false){this.gamedata.sounds[e].audio.pause();if(!isNaN(this.gamedata.sounds[e].audio.duration)){this.gamedata.sounds[e].audio.currentTime=0}}this.gamedata.sounds[e].audio.play()}}},randomInteger:function(t,e){e=e-t+1;var a=Math.floor(Math.random()*e)+t;return a},shapeIndexByName:function(t){for(var e=0;e<this.gamedata.frames.length;e++){if(this.gamedata.frames[e].filename==t)return e}console.log("** ERROR ** shapeIndexByName('"+t+"') - filename not found.");throw"lcdgames.js - "+arguments.callee.caller.toString()+", no frame with filename '"+t+"'";return-1},setShapeByName:function(t,e){if(this.gamedata.frames){for(var a=0;a<this.gamedata.frames.length;a++){if(this.gamedata.frames[a].filename==t){this.gamedata.frames[a].value=e;this._refresh=true;return true}}throw"lcdgames.js - "+arguments.callee.caller.toString()+", no frame with filename '"+t+"'"}return false},setShapeByIdx:function(t,e){this.gamedata.frames[t].value=e;this._refresh=true;return true},sequenceIndexByName:function(t){if(this.gamedata.sequences){for(var e=0;e<this.gamedata.sequences.length;e++){if(this.gamedata.sequences[e].name==t)return e}console.log("** ERROR ** sequenceIndexByName('"+t+"') - sequence name not found.");throw"lcdgames.js - "+arguments.callee.caller.toString()+", no sequence with name '"+t+"'"}return-1},sequenceResetAll:function(t,e){if(typeof e==="undefined")e=false;var a=this.sequenceIndexByName(t);for(var s=0;s<this.gamedata.sequences[a].ids.length;s++){var i=this.gamedata.sequences[a].ids[s];this.gamedata.frames[i].value=e}this._refresh=true},sequenceClear:function(t){this.sequenceResetAll(t)},sequenceShift:function(t,e){var a=this.sequenceIndexByName(t);if(typeof e==="undefined")e=this.gamedata.sequences[a].ids.length;var s;var i=false;for(s=e-1;s>0;s--){var n=this.gamedata.sequences[a].ids[s-1];var o=this.gamedata.sequences[a].ids[s];if(s==e-1)i=this.gamedata.frames[o].value;this.gamedata.frames[o].value=this.gamedata.frames[n].value}var n=this.gamedata.sequences[a].ids[0];this.gamedata.frames[n].value=false;this._refresh=true;return i},sequenceShiftReverse:function(t,e){var a=this.sequenceIndexByName(t);if(typeof e==="undefined")e=0;var s;for(s=e;s<this.gamedata.sequences[a].ids.length-1;s++){var i=this.gamedata.sequences[a].ids[s];var n=this.gamedata.sequences[a].ids[s+1];this.gamedata.frames[i].value=this.gamedata.frames[n].value}var i=this.gamedata.sequences[a].ids[s];this.gamedata.frames[i].value=false;this._refresh=true},sequenceSetFirst:function(t,e){var a=this.sequenceIndexByName(t);var s=this.gamedata.sequences[a].ids[0];this.gamedata.frames[s].value=e;this._refresh=true},sequenceSetPos:function(t,e,a){if(this.gamedata.sequences){var s=this.sequenceIndexByName(t);if(e==-1){e=this.gamedata.sequences[s].ids.length-1}if(e<this.gamedata.sequences[s].ids.length){var i=this.gamedata.sequences[s].ids[e];this.gamedata.frames[i].value=a;this._refresh=true}}},shapeVisible:function(t){for(var e=0;e<this.gamedata.frames.length;e++){if(this.gamedata.frames[e].filename==t){if(this.gamedata.frames[e].value==true){return true}}}return false},sequenceShapeVisible:function(t,e){var a=this.sequenceIndexByName(t);if(typeof e==="undefined"){for(var s=0;s<this.gamedata.sequences[a].ids.length;s++){var i=this.gamedata.sequences[a].ids[s];if(this.gamedata.frames[i].value==true){return true}}}else{if(e==-1){e=this.gamedata.sequences[a].ids.length-1}if(e<this.gamedata.sequences[a].ids.length){var i=this.gamedata.sequences[a].ids[e];if(this.gamedata.frames[i].value==true){return true}}}return false},sequenceAllVisible:function(t,e){var a=this.sequenceIndexByName(t);for(var s=0;s<this.gamedata.sequences[a].ids.length;s++){var i=this.gamedata.sequences[a].ids[s];if(this.gamedata.frames[i].value!=e){return false}}return true},shapesDisplayAll:function(t){if(this.gamedata.frames){for(var e=0;e<this.gamedata.frames.length;e++){if(this.gamedata.frames[e].type=="shape"||this.gamedata.frames[e].type=="digitpos"){this.gamedata.frames[e].value=t}}if(t==true){for(var e=0;e<this.gamedata.digits.length;e++){this.digitsDisplay(this.gamedata.digits[e].name,this.gamedata.digits[e].max)}}this._refresh=true}},digitsDisplay:function(t,e,a){if(!this.gamedata.digits)return;var s=-1;for(var i=0;i<this.gamedata.digits.length;i++){if(this.gamedata.digits[i].name==t){s=i;break}}if(s==-1){console.log("** ERROR ** digitsDisplay('"+t+"') - digits not found.");throw"lcdgames.js - digitsDisplay, no digits with name '"+t+"'"}else{var n=0;var o=0;if(a==true){o=this.gamedata.digits[s].locids.length-e.length;if(o<0){n=Math.abs(o);o=0}}for(var i=0;i<this.gamedata.digits[s].locids.length;i++){var r=this.gamedata.digits[s].locids[i];if(i<o||n>=e.length){this.gamedata.frames[r].value=false}else{var h=e.charCodeAt(n)-48;if(h>=0&&h<this.gamedata.digits[s].ids.length){var d=this.gamedata.digits[s].ids[h];this.gamedata.frames[r].frame.x=this.gamedata.frames[d].frame.x;this.gamedata.frames[r].frame.y=this.gamedata.frames[d].frame.y;this.gamedata.frames[r].value=true}else{this.gamedata.frames[r].value=false}n=n+1}}this._refresh=true}},shapesRefresh:function(){if(this.gamedata.frames){this.context2d.drawImage(this.imageBackground,0,0);for(var t=0;t<this.gamedata.frames.length;t++){if(this.gamedata.frames[t].value==true){this.shapeDraw(t)}}this.drawDebugText()}this._refresh=false},shapeDraw:function(t){this.context2d.drawImage(this.imageShapes,this.gamedata.frames[t].frame.x,this.gamedata.frames[t].frame.y,this.gamedata.frames[t].frame.w,this.gamedata.frames[t].frame.h,this.gamedata.frames[t].spriteSourceSize.x,this.gamedata.frames[t].spriteSourceSize.y,this.gamedata.frames[t].spriteSourceSize.w,this.gamedata.frames[t].spriteSourceSize.h)},debugText:function(t){this.debugtxt=t},drawDebugText:function(){if(this.debugtxt){this.context2d.font="bold 24px sans-serif";var t=50;var e=50;var a=15;var s=this.debugtxt.split("\n");for(var i=0;i<s.length;i++){this.context2d.fillStyle="#000";this.context2d.fillText(s[i],t+2,e+2);this.context2d.fillStyle="#fff";this.context2d.fillText(s[i],t,e);e=e+a}}},buttonAdd:function(t,e,a){if(typeof this.buttons==="undefined"){this.buttons=[]}var s=this.gamedata.buttons.length;this.gamedata.buttons[s]={};this.gamedata.buttons[s].name=t;this.gamedata.buttons[s].frames=e;this.gamedata.buttons[s].defaultkeys=a;this.gamedata.buttons[s].keycodes=this.determineKeyCodes(a)},determineKeyCodes:function(t){var e=[];for(var a=0;a<t.length;a++){var s=0;var i=t[a];i=i.toUpperCase();if(i.indexOf("PGUP")>-1){s=33}else if(i.indexOf("PGDN")>-1){s=34}else if(i.indexOf("END")>-1){s=35}else if(i.indexOf("HOME")>-1){s=36}else if(i.indexOf("UP")>-1){s=38}else if(i.indexOf("DOWN")>-1){s=40}else if(i.indexOf("LEFT")>-1){s=37}else if(i.indexOf("RIGHT")>-1){s=39}else{s=i.charCodeAt(0)}e.push(s)}return e},ontouchstart:function(t){t.preventDefault();for(var e=0;e<event.changedTouches.length;e++){this.onmousedown(event.changedTouches[e])}},ontouchend:function(t){t.preventDefault();for(var e=0;e<t.changedTouches.length;e++){this.onmouseup(t.changedTouches[e])}},onmousedown:function(t){var e=t.offsetX||t.clientX-t.target.offsetLeft;var a=t.offsetY||t.clientY-t.target.offsetTop;e=e/this.scaleFactor;a=a/this.scaleFactor;for(var s=0;s<this.gamedata.buttons.length;s++){if(e>this.gamedata.buttons[s].area.x1&&e<this.gamedata.buttons[s].area.x2&&a>this.gamedata.buttons[s].area.y1&&a<this.gamedata.buttons[s].area.y2){var i=0;switch(this.gamedata.buttons[s].type){case"updown":var n=(this.gamedata.buttons[s].area.y2-this.gamedata.buttons[s].area.y1)/2;i=a<this.gamedata.buttons[s].area.y1+n?0:1;break;case"leftright":var o=(this.gamedata.buttons[s].area.x2-this.gamedata.buttons[s].area.x1)/2;i=e<this.gamedata.buttons[s].area.x1+o?0:1;break;case"dpad":var o=(this.gamedata.buttons[s].area.x2-this.gamedata.buttons[s].area.x1)/2;var n=(this.gamedata.buttons[s].area.y2-this.gamedata.buttons[s].area.y1)/2;var r=e-this.gamedata.buttons[s].area.x1-o;var h=a-this.gamedata.buttons[s].area.y1-n;if(Math.abs(r)<Math.abs(h)){i=h<0?0:1}else{i=r<0?2:3};break}this.onButtonDown(s,i)}}},onmouseup:function(t){var e=t.offsetX||t.clientX-t.target.offsetLeft;var a=t.offsetY||t.clientY-t.target.offsetTop;var e=e/this.scaleFactor;var a=a/this.scaleFactor;for(var s=0;s<this.gamedata.buttons.length;s++){if(e>this.gamedata.buttons[s].area.x1&&e<this.gamedata.buttons[s].area.x2&&a>this.gamedata.buttons[s].area.y1&&a<this.gamedata.buttons[s].area.y2){var i=0;switch(this.gamedata.buttons[s].type){case"updown":var n=(this.gamedata.buttons[s].area.y2-this.gamedata.buttons[s].area.y1)/2;i=a<this.gamedata.buttons[s].area.y1+n?0:1;break;case"leftright":var n=(this.gamedata.buttons[s].area.x2-this.gamedata.buttons[s].area.x1)/2;i=e<this.gamedata.buttons[s].area.x1+n?0:1;break;case"dpad":var o=(this.gamedata.buttons[s].area.x2-this.gamedata.buttons[s].area.x1)/2;var r=(this.gamedata.buttons[s].area.y2-this.gamedata.buttons[s].area.y1)/2;var h=e-this.gamedata.buttons[s].area.x1-o;var d=a-this.gamedata.buttons[s].area.y1-r;if(Math.abs(h)<Math.abs(d)){i=d<0?0:1}else{i=h<0?2:3};break}this.onButtonUp(s,i)}}},onkeydown:function(t){var e=t.keyCode;for(var a=0;a<this.gamedata.buttons.length;a++){for(var s=0;s<this.gamedata.buttons[a].keycodes.length;s++){if(this.gamedata.buttons[a].keycodes[s]==e){this.onButtonDown(a,s)}}}},onkeyup:function(t){var e=t.keyCode;for(var a=0;a<this.gamedata.buttons.length;a++){for(var s=0;s<this.gamedata.buttons[a].keycodes.length;s++){if(this.gamedata.buttons[a].keycodes[s]==e){this.onButtonUp(a)}}}},onButtonDown:function(t,e){var a=this.gamedata.buttons[t].name;if(e>=this.gamedata.buttons[t].ids.length){e=e%this.gamedata.buttons[t].ids.length}this.state.currentState().press(a,e);this.buttonpress++;var s=this.gamedata.buttons[t].ids[e];this.setShapeByIdx(s,true)},onButtonUp:function(t,e){for(var a=0;a<this.gamedata.buttons[t].ids.length;a++){var s=this.gamedata.buttons[t].ids[a];this.setShapeByIdx(s,false)}if(typeof this.state.currentState().release!=="undefined"){var i=this.gamedata.buttons[t].name;this.state.currentState().release(i,e)}},debugRectangle:function(t,e,a,s){var i="#f0f";this.context2d.beginPath();this.context2d.lineWidth="1";this.context2d.strokeStyle=i;this.context2d.fillStyle=i;this.context2d.rect(t,e,a,s);this.context2d.stroke()},is_touch_device:function(){var t=document.createElement("div");t.setAttribute("lcdgame.js - ongesturestart","return;");if(typeof t.ongesturestart==="function"){return true}else{return false}}};LCDGame.BPMToMillSec=function(t){return 6e4/t};LCDGame.Shape=function(t,e){this.lcdgame=t;this.framename=e;this.idx=0};LCDGame.Button=function(t,e){this.lcdgame=t;this.name=e;this.keycodes=[]};LCDGame.Timer=function(t,e,a,s){this.context=t;this.callback=e;this.interval=a||1e3;this.waitfirst=s;this.counter=0;this.max=null;this.enabled=false;this.timerId=0;this.lasttime=0};LCDGame.Timer.prototype={update:function(t){var e=this.callback.name;var a=t-this.lasttime;if(a>=this.interval){this.lasttime=this.lasttime+this.interval;this.doTimerEvent()}},doTimerEvent:function(){this.counter++;this.callback.call(this.context,this);if(typeof this.max!=="undefined"){if(this.counter>=this.max)this.enabled=false}},start:function(t,e){if(typeof e!=="undefined")this.waitfirst=e;this.enabled=true;this.counter=0;this.max=t;this.lasttime=this.context.lcdgame.raf.raftime||0;if(this.waitfirst==false)this.lasttime-=this.interval},pause:function(){this.enabled=false},unpause:function(){this.lasttime=this.context.lcdgame.raf.raftime||0;if(this.waitfirst==false)this.lasttime-=this.interval;this.enabled=true}};