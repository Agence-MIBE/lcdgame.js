/* LCD game JavaScript library -- by BdR 2018 */

var LCDGame=LCDGame||{gamedata:[],imageBackground:null,imageShapes:null,loadsounds:null,countimages:0,scaleFactor:1,gametype:0,level:0,onImageLoaded:null,onImageError:null,canvas:null,context2d:null};LCDGame.Game=function(a,t){return document.body.scrollTop=0,document.body.style.overflow="hidden",this.countimages=0,this.scaleFactor=1,this.imageBackground=new Image,this.imageShapes=new Image,this.imageBackground.addEventListener?(this.imageBackground.addEventListener("load",this.onImageLoaded.bind(this)),this.imageBackground.addEventListener("error",this.onImageError.bind(this)),this.imageShapes.addEventListener("load",this.onImageLoaded.bind(this)),this.imageShapes.addEventListener("error",this.onImageError.bind(this))):(this.imageBackground.attachEvent("load",this.onImageLoaded.bind(this)),this.imageBackground.attachEvent("error",this.onImageError.bind(this)),this.imageShapes.attachEvent("load",this.onImageLoaded.bind(this)),this.imageShapes.attachEvent("error",this.onImageError.bind(this))),this.loadJSON(t),this.canvas=document.createElement("canvas"),document.body.appendChild(this.canvas),this.context2d=this.canvas.getContext("2d"),this.GameObj=new a(this),this},LCDGame.Game.prototype={loadJSON:function(a){var t=new XMLHttpRequest;t.onreadystatechange=function(){t.readyState===XMLHttpRequest.DONE&&(200===t.status||0===t.status?this.onJSONsuccess(JSON.parse(t.responseText)):this.onJSONerror(t))}.bind(this),t.open("GET",a,!0),t.send()},onImageLoaded:function(){this.countimages++,2<=this.countimages&&(console.log("lcdgame.js - onImageLoaded.. ready to rock!"),this.initGame())},onImageError:function(){console.log("** ERROR ** lcdgame.js - onImageError.")},onJSONsuccess:function(a){console.log("onJSONsuccess start"),this.gamedata=a,this.imageBackground.src=a.imgback,this.imageShapes.src=a.imgshapes;for(var t=0;t<this.gamedata.frames.length;t++)this.gamedata.frames[t].value=!1,this.gamedata.frames[t].valprev=!1,this.gamedata.frames[t].type="shape";for(var e=0;e<this.gamedata.sequences.length;e++){this.gamedata.sequences[e].ids=[];for(var s=0;s<this.gamedata.sequences[e].frames.length;s++){var i=this.gamedata.sequences[e].frames[s],n=this.shapeIndexByName(i);this.gamedata.sequences[e].ids.push(n)}}for(var h=0;h<this.gamedata.digits.length;h++){this.gamedata.digits[h].ids=[],this.gamedata.digits[h].locids=[];for(s=0;s<this.gamedata.digits[h].frames.length;s++){i=this.gamedata.digits[h].frames[s],n=this.shapeIndexByName(i);this.gamedata.digits[h].ids.push(n),-1!=n&&(this.gamedata.frames[n].type="digit")}for(var d=0;d<this.gamedata.digits[h].locations.length;d++){i=this.gamedata.digits[h].locations[d],n=this.shapeIndexByName(i);this.gamedata.digits[h].locids.push(n)}var o=this.gamedata.digits[h].max||"";if(""==o){for(var r=0;r<this.gamedata.digits[h].locids.length;r++)o+="8";this.gamedata.digits[h].max=o}}for(var m=0;m<this.gamedata.buttons.length;m++){this.gamedata.buttons[m].ids=[];var g=1e4,u=1e4,c=0,f=0;for(s=0;s<this.gamedata.buttons[m].frames.length;s++){i=this.gamedata.buttons[m].frames[s],n=this.shapeIndexByName(i);this.gamedata.buttons[m].ids.push(n);var l=this.gamedata.frames[n].spriteSourceSize;l.x<g&&(g=l.x),l.y<u&&(u=l.y),l.x+l.w>c&&(c=l.x+l.w),l.y+l.h>f&&(f=l.y+l.h)}var v=c-g,b=f-u;g=g-v,u=u-b,c=c+v,f=f+b;this.gamedata.buttons[m].area={x1:g,y1:u,x2:c,y2:f};var y=this.gamedata.buttons[m].name;void 0!==this.gamedata.buttons[m].defaultkeys&&(y=this.gamedata.buttons[m].defaultkeys),this.gamedata.buttons[m].keycodes=this.determineKeyCodes(y)}for(var p=0;p<this.gamedata.buttons.length-1;p++)for(var x=p+1;x<this.gamedata.buttons.length;x++)if(this.gamedata.buttons[p].area.x1<this.gamedata.buttons[x].area.x2&&this.gamedata.buttons[p].area.x2>this.gamedata.buttons[x].area.x1&&this.gamedata.buttons[p].area.y1<this.gamedata.buttons[x].area.y2&&this.gamedata.buttons[p].area.y2>this.gamedata.buttons[x].area.y1){var w=(this.gamedata.buttons[p].area.x1+this.gamedata.buttons[p].area.x2)/2,I=(this.gamedata.buttons[p].area.y1+this.gamedata.buttons[p].area.y2)/2,S=(this.gamedata.buttons[x].area.x1+this.gamedata.buttons[x].area.x2)/2,E=(this.gamedata.buttons[x].area.y1+this.gamedata.buttons[x].area.y2)/2;if(Math.abs(w-S)>Math.abs(I-E))if(S<w){var B=(this.gamedata.buttons[p].area.x1-this.gamedata.buttons[x].area.x2)/2;this.gamedata.buttons[p].area.x1+=B,this.gamedata.buttons[x].area.x2-=B}else{B=(this.gamedata.buttons[p].area.x2-this.gamedata.buttons[x].area.x1)/2;this.gamedata.buttons[p].area.x2-=B,this.gamedata.buttons[x].area.x1+=B}else if(E<I){B=(this.gamedata.buttons[p].area.y1-this.gamedata.buttons[x].area.y2)/2;this.gamedata.buttons[p].area.y1+=B,this.gamedata.buttons[x].area.y2-=B}else{B=(this.gamedata.buttons[p].area.y2-this.gamedata.buttons[x].area.y1)/2;this.gamedata.buttons[p].area.y2-=B,this.gamedata.buttons[x].area.y1+=B}}},onJSONerror:function(a){console.log("** ERROR ** lcdgame.js - onJSONerror: error loading json file"),console.error(a)},resizeCanvas:function(){var a=window.innerWidth/window.innerHeight,t=this.canvas.width/this.canvas.height,e=this.canvas.width,s=this.canvas.height;a<t?(e=window.innerWidth,this.scaleFactor=e/this.canvas.width,s=this.canvas.height*this.scaleFactor):(s=window.innerHeight,this.scaleFactor=s/this.canvas.height,e=this.canvas.width*this.scaleFactor),this.canvas.style.width=e+"px",this.canvas.style.height=s+"px"},initGame:function(){this.canvas.width=this.imageBackground.width,this.canvas.height=this.imageBackground.height,this.resizeCanvas(),this.context2d.drawImage(this.imageBackground,0,0);for(var a=0;a<this.gamedata.sounds.length;a++){var t=this.gamedata.sounds[a].filename;this.gamedata.sounds[a].audio=new Audio(t),this.gamedata.sounds[a].audio.load()}document.addEventListener?(this.canvas.addEventListener("mousedown",this.ontouchdown.bind(this),!1),this.canvas.addEventListener("mouseup",this.ontouchup.bind(this),!1),document.addEventListener("keydown",this.onkeydown.bind(this),!1),document.addEventListener("keyup",this.onkeyup.bind(this),!1)):(this.canvas.attachEvent("mousedown",this.ontouchdown.bind(this)),this.canvas.attachEvent("mouseup",this.ontouchup.bind(this)),document.attachEvent("keydown",this.onkeydown.bind(this)),document.attachEvent("keyup",this.onkeyup.bind(this))),this.GameObj.initialise()},loadSoundEffects:function(){console.log("loadSoundEffects - TODO load sound effects")},soundIndexByName:function(a){for(var t=0;t<this.gamedata.sounds.length;t++)if(this.gamedata.sounds[t].name==a)return t;return-1},playSoundEffect:function(a){var t=this.soundIndexByName(a);0<=t&&(0==this.gamedata.sounds[t].audio.paused&&(this.gamedata.sounds[t].audio.pause(),this.gamedata.sounds[t].audio.currentTime=0),this.gamedata.sounds[t].audio.play())},shapeIndexByName:function(a){console.log("shapeIndexByName -- "+a);for(var t=0;t<this.gamedata.frames.length;t++)if(this.gamedata.frames[t].filename==a)return t;throw console.log("** ERROR ** shapeIndexByName('"+a+"') - filename not found."),"lcdgames.js - "+arguments.callee.caller.toString()+", no frame with filename '"+a+"'"},setShapeByName:function(a,t){for(var e=0;e<this.gamedata.frames.length;e++)if(this.gamedata.frames[e].filename==a)return this.gamedata.frames[e].value=t,!0;return!1},setShapeByIdx:function(a,t){return this.gamedata.frames[a].value=t,!0},sequenceIndexByName:function(a){for(var t=0;t<this.gamedata.sequences.length;t++)if(this.gamedata.sequences[t].name==a)return t;throw console.log("** ERROR ** sequenceIndexByName('"+a+"') - sequence name not found."),"lcdgames.js - "+arguments.callee.caller.toString()+", no sequence with name '"+a+"'"},sequenceClear:function(a){for(var t=this.sequenceIndexByName(a),e=0;e<this.gamedata.sequences[t].ids.length;e++){var s=this.gamedata.sequences[t].ids[e];this.gamedata.frames[s].value=!1}},sequenceShift:function(a,t){var e,s=this.sequenceIndexByName(a);for(void 0===t&&(t=this.gamedata.sequences[s].ids.length),e=t-1;0<e;e--){var i=this.gamedata.sequences[s].ids[e-1],n=this.gamedata.sequences[s].ids[e];this.gamedata.frames[n].value=this.gamedata.frames[i].value}i=this.gamedata.sequences[s].ids[0];this.gamedata.frames[i].value=!1},sequenceShiftReverse:function(a,t){var e,s=this.sequenceIndexByName(a);for(void 0===t&&(t=0),e=t;e<this.gamedata.sequences[s].ids.length-1;e++){var i=this.gamedata.sequences[s].ids[e],n=this.gamedata.sequences[s].ids[e+1];this.gamedata.frames[i].value=this.gamedata.frames[n].value}i=this.gamedata.sequences[s].ids[e];this.gamedata.frames[i].value=!1},sequenceSetFirst:function(a,t){var e=this.sequenceIndexByName(a),s=this.gamedata.sequences[e].ids[0];this.gamedata.frames[s].value=t},sequenceSetPos:function(a,t,e){var s=this.sequenceIndexByName(a);-1==t&&(t=this.gamedata.sequences[s].ids.length-1);var i=this.gamedata.sequences[s].ids[t];this.gamedata.frames[i].value=e},sequenceShapeVisible:function(a,t){var e=this.sequenceIndexByName(a);if(void 0===t)for(var s=0;s<this.gamedata.sequences[e].ids.length;s++){var i=this.gamedata.sequences[e].ids[s];if(1==this.gamedata.frames[i].value)return!0}else{-1==t&&(t=this.gamedata.sequences[e].ids.length-1);i=this.gamedata.sequences[e].ids[t];if(1==this.gamedata.frames[i].value)return!0}return!1},shapesDisplayAll:function(a){for(var t=0;t<this.gamedata.frames.length;t++)"shape"!=this.gamedata.frames[t].type&&"digitpos"!=this.gamedata.frames[t].type||(this.gamedata.frames[t].value=a);if(1==a)for(t=0;t<this.gamedata.digits.length;t++)this.digitsDisplay(this.gamedata.digits[t].name,this.gamedata.digits[t].max)},digitsDisplay:function(a,t,e){for(var s=-1,i=0;i<this.gamedata.digits.length;i++)if(this.gamedata.digits[i].name==a){s=i;break}if(-1!=s){var n=0,h=0;1==e&&(h=this.gamedata.digits[s].locids.length-t.length)<0&&(n=Math.abs(h),h=0);for(i=0;i<this.gamedata.digits[s].locids.length;i++){var d=this.gamedata.digits[s].locids[i];if(i<h||n>=t.length)this.gamedata.frames[d].value=!1;else{var o=t.charCodeAt(n)-48;if(0<=o&&o<this.gamedata.digits[s].ids.length){var r=this.gamedata.digits[s].ids[o];this.gamedata.frames[d].frame.x=this.gamedata.frames[r].frame.x,this.gamedata.frames[d].frame.y=this.gamedata.frames[r].frame.y,this.gamedata.frames[d].value=!0}else this.gamedata.frames[d].value=!1;n+=1}}}},shapesRefresh:function(){this.context2d.drawImage(this.imageBackground,0,0);for(var a=0;a<this.gamedata.frames.length;a++)1==this.gamedata.frames[a].value&&this.shapeDraw(a)},shapeDraw:function(a){this.context2d.drawImage(this.imageShapes,this.gamedata.frames[a].frame.x,this.gamedata.frames[a].frame.y,this.gamedata.frames[a].frame.w,this.gamedata.frames[a].frame.h,this.gamedata.frames[a].spriteSourceSize.x,this.gamedata.frames[a].spriteSourceSize.y,this.gamedata.frames[a].spriteSourceSize.w,this.gamedata.frames[a].spriteSourceSize.h)},buttonAdd:function(a,t,e){void 0===this.buttons&&(this.buttons=[]);var s=this.gamedata.buttons.length;this.gamedata.buttons[s]={},this.gamedata.buttons[s].name=a,this.gamedata.buttons[s].frames=t,this.gamedata.buttons[s].defaultkeys=e,this.gamedata.buttons[s].keycodes=this.determineKeyCodes(e)},determineKeyCodes:function(a){for(var t=[],e=0;e<a.length;e++){var s=0,i=a[e];s=-1<(i=i.toUpperCase()).indexOf("UP")?38:-1<i.indexOf("DOWN")?40:-1<i.indexOf("LEFT")?37:-1<i.indexOf("RIGHT")?39:i.charCodeAt(0),t.push(s)}return t},ontouchdown:function(a){for(var t=a.offsetX/this.scaleFactor,e=a.offsetY/this.scaleFactor,s=0;s<this.gamedata.buttons.length;s++)if(t>this.gamedata.buttons[s].area.x1&&t<this.gamedata.buttons[s].area.x2&&e>this.gamedata.buttons[s].area.y1&&e<this.gamedata.buttons[s].area.y2){var i=0;switch(this.gamedata.buttons[s].type){case"updown":var n=(this.gamedata.buttons[s].area.y2-this.gamedata.buttons[s].area.y1)/2;i=e<this.gamedata.buttons[s].area.y1+n?0:1;break;case"leftright":n=(this.gamedata.buttons[s].area.x2-this.gamedata.buttons[s].area.x1)/2;i=t<this.gamedata.buttons[s].area.x1+n?0:1}this.onButtonDown(s,i)}},ontouchup:function(a){for(var t=a.offsetX/this.scaleFactor,e=a.offsetY/this.scaleFactor,s=0;s<this.gamedata.buttons.length;s++)if(t>this.gamedata.buttons[s].area.x1&&t<this.gamedata.buttons[s].area.x2&&e>this.gamedata.buttons[s].area.y1&&e<this.gamedata.buttons[s].area.y2){var i=0;switch(this.gamedata.buttons[s].type){case"updown":var n=(this.gamedata.buttons[s].area.y2-this.gamedata.buttons[s].area.y1)/2;i=e<this.gamedata.buttons[s].area.y1+n?0:1;break;case"leftright":n=(this.gamedata.buttons[s].area.x2-this.gamedata.buttons[s].area.x1)/2;i=t<this.gamedata.buttons[s].area.x1+n?0:1}this.onButtonUp(s,i)}},onkeydown:function(a){for(var t=a.keyCode,e=0;e<this.gamedata.buttons.length;e++)for(var s=0;s<this.gamedata.buttons[e].keycodes.length;s++)this.gamedata.buttons[e].keycodes[s]==t&&this.onButtonDown(e,s)},onkeyup:function(a){for(var t=a.keyCode,e=0;e<this.gamedata.buttons.length;e++)for(var s=0;s<this.gamedata.buttons[e].keycodes.length;s++)this.gamedata.buttons[e].keycodes[s]==t&&this.onButtonUp(e)},onButtonDown:function(a,t){var e=this.gamedata.buttons[a].name;this.GameObj.handleInput(e,t);var s=this.gamedata.buttons[a].ids[t];this.setShapeByIdx(s,!0),this.shapesRefresh()},onButtonUp:function(a,t){for(var e=0;e<this.gamedata.buttons[a].ids.length;e++){var s=this.gamedata.buttons[a].ids[e];this.setShapeByIdx(s,!1)}this.shapesRefresh()},debugRectangle:function(a,t,e,s){this.context2d.beginPath(),this.context2d.lineWidth="1",this.context2d.strokeStyle="#f0f",this.context2d.fillStyle="#f0f",this.context2d.rect(a,t,e,s),this.context2d.stroke()},is_touch_device:function(){var a=document.createElement("div");return a.setAttribute("lcdgame.js - ongesturestart","return;"),"function"==typeof a.ongesturestart}},LCDGame.BPMToMillSec=function(a){return 6e4/a},LCDGame.Shape=function(a,t){this.lcdgame=a,this.framename=t,this.idx=0},LCDGame.Button=function(a,t){this.lcdgame=a,this.name=t,this.keycodes=[]},LCDGame.Timer=function(a,t,e){this.game=a,this.Interval=e||1e3,this.Counter=0,this.Max=null,this.Enable=new Boolean(!1),this.doGameEvent=t;this.doTimerEvent=function(){this.Counter++,this.doGameEvent.call(this.game),void 0!==this.Max&&this.Counter>=this.Max&&this.Stop()},this.Start=function(a){this.Enable=new Boolean(!0),this.Counter=0,this.Max=a;var t=this.doTimerEvent.bind(this);this.Enable&&(this.timerId&&clearInterval(this.timerId),this.timerId=setInterval(t,this.Interval))},this.Stop=function(){this.Enable=new Boolean(!1),clearInterval(this.timerId)}};